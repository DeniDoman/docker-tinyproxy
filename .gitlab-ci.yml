default:
  image: docker:20.10
  services:
    - docker:20.10-dind

stages:
  - build
  - distribute

variables:
  # Empty tag will become the tag "latest".
  IMAGE_TAG: ""

workflow:
  rules:
    - if: $CI_COMMIT_REF_NAME != $CI_DEFAULT_BRANCH
      variables:
        IMAGE_TAG: ":$CI_COMMIT_REF_SLUG"
    - when: always

build:
  stage: build
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
  script:
    - docker build --pull -t "${CI_REGISTRY_IMAGE}${IMAGE_TAG}" .
    - docker push "${CI_REGISTRY_IMAGE}${IMAGE_TAG}"

distribute:
  stage: distribute
  before_script:
    - docker login -u "$EXT_REGISTRY_USER" -p "$EXT_REGISTRY_PASSWORD" "$EXT_REGISTRY"
  script:
    - docker pull "${CI_REGISTRY_IMAGE}${IMAGE_TAG}"
    - docker tag "${CI_REGISTRY_IMAGE}${IMAGE_TAG}" "${EXT_REGISTRY_IMAGE}${IMAGE_TAG}"
    - docker push "${EXT_REGISTRY_IMAGE}${IMAGE_TAG}"
  only:
    variables:
      - $EXT_REGISTRY